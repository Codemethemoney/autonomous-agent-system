<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Bot Builder</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Main layout */
        .container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #f5f5f5;
            border-right: 1px solid #ddd;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Main content area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Tab navigation */
        .tab-nav {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 0 20px;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
        }

        .tab-button:hover {
            color: #1a73e8;
        }

        /* Tab content */
        .tab-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* Chat area */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #fff;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
        }

        .user-message {
            background: #E3F2FD;
            margin-left: auto;
        }

        .bot-message {
            background: #F5F5F5;
            margin-right: auto;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #ddd;
            background: #fff;
        }

        .chat-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
            margin-bottom: 12px;
        }

        /* API Keys section */
        .api-keys {
            margin-bottom: 30px;
        }

        .api-keys input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* System Instructions */
        .system-instructions {
            margin-bottom: 30px;
        }

        .system-instructions-textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
            background: #fff;
        }

        .system-instructions-container {
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
        }

        .system-instructions textarea {
            width: 100%;
            min-height: 150px;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }

        /* Buttons */
        .button {
            background: #1a73e8;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .button:hover {
            background: #1557b0;
        }

        /* Project Knowledge section */
        .project-knowledge {
            margin-top: auto;
            padding-top: 20px;
        }

        /* Tab styles */
        .tab-bar {
            display: flex;
            background: #f0f0f0;
            padding: 10px;
            gap: 10px;
        }

        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .tab-button.active {
            border-bottom-color: #00ff00;
            background-color: rgba(0, 255, 0, 0.1);
        }

        .tab-content {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
        }

        .workshop {
            display: none;
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }

        .workshop.active {
            display: block;
        }

        .workshop-section {
            margin-bottom: 30px;
        }

        .tool-form, .workflow-form {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .parameters-list {
            margin-top: 10px;
        }

        .parameter-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .tool-list, .workflow-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tool-card, .workflow-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .card-description {
            color: #666;
            margin-bottom: 10px;
        }

        .card-metadata {
            font-size: 0.9em;
            color: #888;
        }

        .help-icon {
            cursor: pointer;
            font-size: 20px;
            color: #666;
            margin-left: 10px;
        }

        .help-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .help-modal h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .help-modal ul {
            padding-left: 20px;
        }

        .help-modal li {
            margin-bottom: 10px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 24px;
            color: #666;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .enhanced-suggestions {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .suggestion-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }

        .ask-ai {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1001;
        }

        .research-assistant {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .research-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .research-content {
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
        }

        .research-footer {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .research-examples {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .research-example {
            cursor: pointer;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .research-example:hover {
            background: #e9ecef;
        }

        .research-query {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .minimize-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }

        .tool-header, .workflow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .generate-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-right: 15px;
        }

        .generate-prompt {
            width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .generate-btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .generate-btn:hover {
            background: #1d4ed8;
        }

        .tooltip {
            position: absolute;
            background: #2a2a2a;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            max-width: 400px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 14px;
            line-height: 1.4;
            display: none;
        }

        .tooltip h4 {
            margin: 0 0 8px 0;
            color: #64B5F6;
        }

        .tooltip-section {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #404040;
        }

        .file-item:hover .tooltip {
            display: block;
        }

        .file-item.has-error {
            position: relative;
        }

        .file-item.has-error::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            animation: pulse-error 2s infinite;
        }

        .error-tooltip {
            display: none;
            position: absolute;
            background: #2d2d2d;
            border: 1px solid #ff4444;
            padding: 15px;
            border-radius: 4px;
            max-width: 400px;
            z-index: 1000;
            color: white;
        }

        .has-error .error-indicator {
            display: block;
        }

        .has-error:hover .error-tooltip {
            display: block;
        }

        .fix-option {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
        }

        .fix-option.safe {
            border-left: 3px solid #4CAF50;
        }

        .fix-option.enhanced {
            border-left: 3px solid #2196F3;
        }

        .fix-description {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .fix-explanation {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 5px;
        }

        .fix-confidence {
            font-size: 0.8em;
            color: #888;
        }

        .apply-fix-btn {
            margin-top: 5px;
            padding: 5px 10px;
            background: #4CAF50;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
        }

        .apply-fix-btn:hover {
            background: #45a049;
        }

        /* Error visualization styles */
        .error-highlight {
            animation: error-pulse 2s infinite;
            position: relative;
        }

        @keyframes error-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        .error-tooltip {
            display: none;
            position: absolute;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 300px;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .error-highlight:hover .error-tooltip {
            display: block;
        }

        .fix-button {
            display: block;
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .fix-button.safe {
            background-color: #4CAF50;
            color: white;
        }

        .fix-button.enhanced {
            background-color: #2196F3;
            color: white;
        }

        .fix-button:hover {
            opacity: 0.9;
        }

        .confidence {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* Workshop styles */
        .workshop-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .workshop-tools {
            padding: 20px;
            flex: 1;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .tool-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .tool-card h4 {
            margin: 0 0 8px 0;
            color: #1a73e8;
        }

        .tool-card p {
            margin: 0;
            color: #666;
        }

        .tool-content {
            margin-top: 30px;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            min-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">🔑 API Keys</div>
                <input type="password" class="api-key-input" id="openaiKey" placeholder="OpenAI API Key">
                <input type="password" class="api-key-input" id="anthropicKey" placeholder="Anthropic API Key">
                <button class="primary-btn" onclick="saveApiKeys()">Save Keys</button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">⚙️ System Instructions</div>
                <div class="system-instructions-container">
                    <textarea 
                        class="system-instructions-textarea" 
                        id="systemInstructions"
                        placeholder="Enter system instructions here..."
                    ></textarea>
                </div>
                <button class="primary-btn" onclick="saveInstructions()">Save Instructions</button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">
                    <span>📚 Project Knowledge</span>
                    <button class="add-content-btn" onclick="document.getElementById('knowledgeUpload').click()">
                        + Add Content
                    </button>
                </div>
                <input type="file" id="knowledgeUpload" style="display: none" multiple>
                <div class="knowledge-list" id="knowledgeList">
                    <!-- Knowledge items will be added here -->
                </div>
            </div>
        </div>
        <div class="main-content">
            <!-- Simple tab navigation -->
            <div class="tab-bar">
                <button data-tab="chat" onclick="showTab('chat')" class="tab-button active">Chat</button>
                <button data-tab="prompts" onclick="showTab('prompts')" class="tab-button">Prompts</button>
                <button data-tab="workshop" onclick="showTab('workshop')" class="tab-button">Workshop</button>
            </div>

            <!-- Tab content sections -->
            <div id="chat-content" class="tab-content" style="display: block;">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be inserted here -->
                    </div>
                    <div class="chat-input-container">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Type your message here..."
                            rows="4"
                        ></textarea>
                        <button id="sendMessage" class="button">Send Message</button>
                    </div>
                </div>
            </div>

            <div id="prompts-content" class="tab-content" style="display: none;">
                <div class="prompt-index">
                    <h2>MCP Tools & Prompts</h2>
                    <div id="promptContent"></div>
                </div>
            </div>

            <div id="workshop" class="tab-content" style="display: none;">
                <div class="workshop-container">
                    <div class="workshop-header">
                        <h2>Workshop</h2>
                        <input type="text" id="workflowSearch" placeholder="Search for tools or workflows..." class="search-input">
                    </div>
                    
                    <div class="workshop-tools">
                        <h3>Available Tools</h3>
                        <div class="tools-grid" id="toolsGrid">
                            <!-- Tools will be dynamically added here -->
                        </div>
                    </div>

                    <div class="workflow-builder">
                        <h3>Workflow Builder</h3>
                        <div class="workflow-steps" id="workflowSteps">
                            <!-- Workflow steps will be added here -->
                        </div>
                        <button class="button" onclick="addWorkflowStep()">Add Step</button>
                        <button class="button primary" onclick="saveWorkflow()">Save Workflow</button>
                    </div>

                    <div class="saved-workflows">
                        <h3>Saved Workflows</h3>
                        <div id="workflowList">
                            <!-- Saved workflows will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header">
            <span class="project-title">🤖 MCP Bot Builder</span>
            <span class="private-badge">Private</span>
        </div>
        <div class="input-area">
            <div class="input-container">
                <select class="model-select" id="modelSelect">
                    <option value="claude">Claude</option>
                    <option value="gpt4">GPT-4</option>
                    <option value="llama2">Llama2</option>
                </select>
                <textarea 
                    class="input-box" 
                    id="inputBox" 
                    placeholder="How can MCP help you today?"
                    rows="1"
                ></textarea>
                <label class="file-upload-label">
                    📎
                    <input type="file" class="file-upload" id="fileUpload" multiple>
                </label>
            </div>
        </div>
    </div>

    <!-- Help Modals -->
    <div class="modal-overlay" id="modalOverlay"></div>
    
    <div class="help-modal" id="toolHelpModal">
        <span class="close-modal" onclick="closeModal('tool')">&times;</span>
        <h3>How to Create a Tool</h3>
        <ul>
            <li><strong>Tool Name:</strong> Use a descriptive, lowercase name with hyphens (e.g., web-scraper, data-processor)</li>
            <li><strong>Tool Type:</strong> Choose the most appropriate category for your tool's primary function</li>
            <li><strong>Description:</strong> Provide a clear, detailed explanation of what the tool does and how it works</li>
            <li><strong>Parameters:</strong> Define all inputs needed to run the tool:
                <ul>
                    <li>Name: Use clear, descriptive parameter names</li>
                    <li>Type: Choose the appropriate data type</li>
                    <li>Description: Explain what the parameter does and any requirements</li>
                </ul>
            </li>
        </ul>
        <h4>Research Tips</h4>
        <ul>
            <li>Review similar existing tools in the repository</li>
            <li>Check documentation for chosen APIs or libraries</li>
            <li>Test your tool's parameters with sample data</li>
            <li>Consider error handling and edge cases</li>
        </ul>
    </div>
    
    <div class="help-modal" id="workflowHelpModal">
        <span class="close-modal" onclick="closeModal('workflow')">&times;</span>
        <h3>How to Create a Workflow</h3>
        <ul>
            <li><strong>Workflow Name:</strong> Use a descriptive name that reflects the entire process</li>
            <li><strong>Description:</strong> Explain the purpose and steps of the workflow</li>
            <li><strong>Steps:</strong> Break down the process into logical steps:
                <ul>
                    <li>Step Name: Clear, ordered names (e.g., "1. Fetch Data", "2. Process Results")</li>
                    <li>Tool Selection: Choose appropriate tools for each step</li>
                    <li>Parameters: Configure how data flows between steps</li>
                </ul>
            </li>
        </ul>
        <h4>Research Tips</h4>
        <ul>
            <li>Map out the entire process before creating steps</li>
            <li>Identify data dependencies between steps</li>
            <li>Consider error handling and recovery</li>
            <li>Test the workflow with sample data</li>
        </ul>
    </div>

    <div id="docsEditor" class="docs-editor">
        <h3>Edit File Documentation</h3>
        <textarea id="docsContent"></textarea>
        <div class="docs-editor-buttons">
            <button class="cancel-btn" onclick="closeDocsEditor()">Cancel</button>
            <button class="save-btn" onclick="saveDocumentation()">Save Changes</button>
        </div>
    </div>

    <div id="testControls" style="position: fixed; bottom: 20px; right: 20px; background: #2a2a2a; padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0;">Test Error Handling</h4>
        <button onclick="testError('division')" style="margin-right: 8px;">Test Division Error</button>
        <button onclick="testError('undefined')" style="margin-right: 8px;">Test Undefined Error</button>
        <button onclick="testError('syntax')">Test Syntax Error</button>
    </div>

    <script>
        const chatArea = document.getElementById('chatArea');
        const inputBox = document.getElementById('inputBox');
        const modelSelect = document.getElementById('modelSelect');
        const fileUpload = document.getElementById('fileUpload');
        const knowledgeUpload = document.getElementById('knowledgeUpload');
        const knowledgeList = document.getElementById('knowledgeList');

        // Load API keys on startup
        fetch('/api/keys')
            .then(response => response.json())
            .then(keys => {
                document.getElementById('openaiKey').value = keys.openai || '';
                document.getElementById('anthropicKey').value = keys.anthropic || '';
            });

        function saveApiKeys() {
            const openaiKey = document.getElementById('openaiKey').value;
            const anthropicKey = document.getElementById('anthropicKey').value;
            
            fetch('/api/keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ openai: openaiKey, anthropic: anthropicKey }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('API keys saved successfully!');
                }
            });
        }

        function saveInstructions() {
            const instructions = document.getElementById('systemInstructions').value;
            localStorage.setItem('systemInstructions', instructions);
            alert('System instructions saved!');
        }

        // Load saved instructions
        const savedInstructions = localStorage.getItem('systemInstructions');
        if (savedInstructions) {
            document.getElementById('systemInstructions').value = savedInstructions;
        }

        // Auto-resize textarea as content grows
        document.getElementById('systemInstructions').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        function addMessage(content, isUser = false, streaming = false) {
            let messageDiv;
            if (streaming) {
                messageDiv = document.querySelector('.message.streaming');
            }
            
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}${streaming ? ' streaming' : ''}`;
                
                const header = document.createElement('div');
                header.className = 'message-header';
                header.textContent = isUser ? 'You' : '🤖 MCP';
                
                const text = document.createElement('div');
                text.className = 'message-content';
                text.textContent = content;
                
                messageDiv.appendChild(header);
                messageDiv.appendChild(text);
                chatArea.appendChild(messageDiv);
            } else {
                const text = messageDiv.querySelector('.message-content');
                text.textContent += content;
            }
            
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function sendMessage() {
            const message = document.getElementById('chatInput').value.trim();
            const model = document.getElementById('modelSelect').value;
            const systemInstructions = document.getElementById('systemInstructions').value;
            
            if (!message) return;

            // Add user message to chat
            addMessage(message, true);
            document.getElementById('chatInput').value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message,
                        model,
                        systemInstructions
                    })
                });

                // Handle streaming response
                const reader = response.body.getReader();
                let decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    
                    for (let i = 0; i < lines.length - 1; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content) {
                                    addMessage(parsed.content, false, true);
                                }
                            } catch (e) {
                                console.error('Error parsing SSE message:', e);
                            }
                        }
                    }
                    buffer = lines[lines.length - 1];
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('Error: Failed to get response from AI service', false);
            }
        }

        // Handle file uploads for chat
        fileUpload.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            const message = inputBox.value.trim();
            if (message || files.length > 0) {
                addMessage(message + (files.length > 0 ? ` (with ${files.length} file${files.length > 1 ? 's' : ''})` : ''), true);
                await sendMessage(message, files);
                inputBox.value = '';
                fileUpload.value = '';
            }
        });

        inputBox.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = inputBox.value.trim();
                const files = Array.from(fileUpload.files);
                if (message || files.length > 0) {
                    addMessage(message + (files.length > 0 ? ` (with ${files.length} file${files.length > 1 ? 's' : ''})` : ''), true);
                    await sendMessage(message, files);
                    inputBox.value = '';
                    fileUpload.value = '';
                }
            }
        });

        // Auto-resize textarea
        inputBox.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Load and display prompt index
        async function loadPromptIndex() {
            try {
                const response = await fetch('/api/prompts');
                const data = await response.json();
                const container = document.getElementById('promptContent');
                
                // Tools section
                const toolsSection = document.createElement('div');
                toolsSection.className = 'prompt-category';
                toolsSection.innerHTML = '<h3>Tools</h3>';
                
                Object.entries(data.tools).forEach(([id, tool]) => {
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'prompt-item';
                    toolDiv.innerHTML = `
                        <div class="prompt-title">${tool.name}</div>
                        <div class="prompt-description">${tool.description}</div>
                        <div class="prompt-examples">
                            ${tool.examples.map(example => `
                                <div class="prompt-example">
                                    <strong>${example.title}</strong>
                                    <pre>${example.prompt}</pre>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    toolsSection.appendChild(toolDiv);
                });
                
                // Workflows section
                const workflowsSection = document.createElement('div');
                workflowsSection.className = 'prompt-category';
                workflowsSection.innerHTML = '<h3>Workflows</h3>';
                
                Object.entries(data.workflows).forEach(([id, workflow]) => {
                    const workflowDiv = document.createElement('div');
                    workflowDiv.className = 'prompt-item';
                    workflowDiv.innerHTML = `
                        <div class="prompt-title">${workflow.name}</div>
                        <div class="prompt-description">${workflow.description}</div>
                        <div class="prompt-examples">
                            ${workflow.examples.map(example => `
                                <div class="prompt-example">
                                    <strong>${example.title}</strong>
                                    <pre>${example.prompt}</pre>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    workflowsSection.appendChild(workflowDiv);
                });
                
                // Specialized prompts section
                const promptsSection = document.createElement('div');
                promptsSection.className = 'prompt-category';
                promptsSection.innerHTML = '<h3>Specialized Prompts</h3>';
                
                Object.entries(data.specialized_prompts).forEach(([category, prompts]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'prompt-category';
                    categoryDiv.innerHTML = `<h4>${category.replace('_', ' ').toUpperCase()}</h4>`;
                    
                    prompts.forEach(prompt => {
                        const promptDiv = document.createElement('div');
                        promptDiv.className = 'prompt-item';
                        promptDiv.innerHTML = `
                            <div class="prompt-title">${prompt.title}</div>
                            <div class="prompt-description">${prompt.context}</div>
                            <div class="prompt-example">
                                <pre>${prompt.prompt}</pre>
                            </div>
                        `;
                        categoryDiv.appendChild(promptDiv);
                    });
                    
                    promptsSection.appendChild(categoryDiv);
                });
                
                container.appendChild(toolsSection);
                container.appendChild(workflowsSection);
                container.appendChild(promptsSection);
                
                // Make prompts clickable
                document.querySelectorAll('.prompt-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const promptText = item.querySelector('pre').textContent;
                        document.querySelector('[data-tab="chat"]').click();
                        inputBox.value = promptText;
                        inputBox.focus();
                    });
                });
                
            } catch (error) {
                console.error('Error loading prompt index:', error);
            }
        }

        // Workshop functionality
        async function loadWorkshop() {
            await Promise.all([
                loadTools(),
                loadWorkflows()
            ]);
        }

        async function loadTools() {
            try {
                const response = await fetch('/api/workshop/tools');
                const tools = await response.json();
                const container = document.getElementById('toolList');
                
                container.innerHTML = tools.map(tool => `
                    <div class="tool-card">
                        <div class="card-header">
                            <div class="card-title">${tool.name}</div>
                            <div class="card-actions">
                                <button onclick="executeTool('${tool.name}')" class="secondary-btn">Run</button>
                                <button onclick="editTool('${tool.name}')" class="secondary-btn">Edit</button>
                            </div>
                        </div>
                        <div class="card-description">${tool.description}</div>
                        <div class="card-metadata">
                            Type: ${tool.type} | Created: ${new Date(tool.created).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tools:', error);
            }
        }

        async function loadWorkflows() {
            try {
                const response = await fetch('/api/workshop/workflows');
                const workflows = await response.json();
                const container = document.getElementById('workflowList');
                
                container.innerHTML = workflows.map(workflow => `
                    <div class="workflow-card">
                        <div class="card-header">
                            <div class="card-title">${workflow.name}</div>
                            <div class="card-actions">
                                <button onclick="executeWorkflow('${workflow.name}')" class="secondary-btn">Run</button>
                                <button onclick="editWorkflow('${workflow.name}')" class="secondary-btn">Edit</button>
                            </div>
                        </div>
                        <div class="card-description">${workflow.description}</div>
                        <div class="card-metadata">
                            Steps: ${workflow.steps.length} | Created: ${new Date(workflow.created).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading workflows:', error);
            }
        }

        function addParameter() {
            const container = document.getElementById('parametersContainer');
            const paramDiv = document.createElement('div');
            paramDiv.className = 'parameter-item';
            paramDiv.innerHTML = `
                <input type="text" placeholder="Parameter name" class="param-name">
                <select class="param-type">
                    <option value="string">String</option>
                    <option value="number">Number</option>
                    <option value="boolean">Boolean</option>
                    <option value="array">Array</option>
                    <option value="object">Object</option>
                </select>
                <input type="text" placeholder="Description" class="param-desc">
                <button onclick="this.parentElement.remove()" class="secondary-btn">Remove</button>
            `;
            container.appendChild(paramDiv);
        }

        function addWorkflowStep() {
            const container = document.getElementById('stepsContainer');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'parameter-item';
            stepDiv.innerHTML = `
                <input type="text" placeholder="Step name" class="step-name">
                <select class="step-tool">
                    <!-- Will be populated with available tools -->
                </select>
                <input type="text" placeholder="Parameters (JSON)" class="step-params">
                <button onclick="this.parentElement.remove()" class="secondary-btn">Remove</button>
            `;
            container.appendChild(stepDiv);
            loadToolsForSelect(stepDiv.querySelector('.step-tool'));
        }

        async function loadToolsForSelect(select) {
            try {
                const response = await fetch('/api/workshop/tools');
                const tools = await response.json();
                select.innerHTML = tools.map(tool => 
                    `<option value="${tool.name}">${tool.name}</option>`
                ).join('');
            } catch (error) {
                console.error('Error loading tools for select:', error);
            }
        }

        async function createTool() {
            const name = document.getElementById('toolName').value;
            const type = document.getElementById('toolType').value;
            const description = document.getElementById('toolDescription').value;
            
            const parameters = Array.from(document.querySelectorAll('.parameter-item')).map(item => ({
                name: item.querySelector('.param-name').value,
                type: item.querySelector('.param-type').value,
                description: item.querySelector('.param-desc').value
            }));

            try {
                const response = await fetch('/api/workshop/tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, type, description, parameters })
                });

                if (response.ok) {
                    alert('Tool created successfully!');
                    loadTools();
                } else {
                    throw new Error('Failed to create tool');
                }
            } catch (error) {
                console.error('Error creating tool:', error);
                alert('Error creating tool: ' + error.message);
            }
        }

        async function createWorkflow() {
            const name = document.getElementById('workflowName').value;
            const description = document.getElementById('workflowDescription').value;
            
            const steps = Array.from(document.querySelectorAll('.parameter-item')).map(item => ({
                name: item.querySelector('.step-name').value,
                tool: item.querySelector('.step-tool').value,
                params: JSON.parse(item.querySelector('.step-params').value || '{}')
            }));

            try {
                const response = await fetch('/api/workshop/workflow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, steps })
                });

                if (response.ok) {
                    alert('Workflow created successfully!');
                    loadWorkflows();
                } else {
                    throw new Error('Failed to create workflow');
                }
            } catch (error) {
                console.error('Error creating workflow:', error);
                alert('Error creating workflow: ' + error.message);
            }
        }

        async function executeWorkflow(name) {
            try {
                const params = prompt('Enter workflow parameters (JSON):');
                const response = await fetch('/api/workshop/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        workflow: name,
                        params: JSON.parse(params || '{}')
                    })
                });

                const result = await response.json();
                
                console.log('Workflow execution result:', result);
                alert('Workflow executed successfully!');
            } catch (error) {
                console.error('Error executing workflow:', error);
                alert('Error executing workflow: ' + error.message);
            }
        }

        function showHelp(type) {
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById(`${type}HelpModal`).style.display = 'block';
        }

        function closeModal(type) {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById(`${type}HelpModal`).style.display = 'none';
        }

        async function getEnhancedSuggestions(type) {
            const container = document.getElementById(`${type}Suggestions`);
            container.style.display = 'block';
            
            let currentData = {};
            if (type === 'tool') {
                currentData = {
                    name: document.getElementById('toolName').value,
                    type: document.getElementById('toolType').value,
                    description: document.getElementById('toolDescription').value,
                    parameters: Array.from(document.querySelectorAll('.parameter-item')).map(item => ({
                        name: item.querySelector('.param-name').value,
                        type: item.querySelector('.param-type').value,
                        description: item.querySelector('.param-desc').value
                    }))
                };
            } else {
                currentData = {
                    name: document.getElementById('workflowName').value,
                    description: document.getElementById('workflowDescription').value,
                    steps: Array.from(document.querySelectorAll('.step-item')).map(item => ({
                        name: item.querySelector('.step-name').value,
                        tool: item.querySelector('.step-tool').value,
                        params: item.querySelector('.step-params').value
                    }))
                };
            }

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Analyze this ${type} and suggest improvements:\n${JSON.stringify(currentData, null, 2)}`,
                        model: 'gpt-4'
                    })
                });

                const suggestions = await response.json();
                container.innerHTML = `
                    <h4>Enhanced Suggestions</h4>
                    <div class="suggestion-item">
                        <strong>Improvements:</strong>
                        <pre>${suggestions.content}</pre>
                    </div>
                `;
            } catch (error) {
                console.error('Error getting suggestions:', error);
                container.innerHTML = '<p>Error getting suggestions. Please try again.</p>';
            }
        }

        async function askAI() {
            const query = prompt('What would you like to know about tools or workflows?');
            if (!query) return;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: query,
                        model: 'gpt-4'
                    })
                });

                const result = await response.json();
                
                // Create and show modal with response
                const modal = document.createElement('div');
                modal.className = 'help-modal';
                modal.innerHTML = `
                    <span class="close-modal" onclick="this.parentElement.remove();document.getElementById('modalOverlay').style.display='none'">&times;</span>
                    <h3>AI Response</h3>
                    <div>${result.content}</div>
                `;
                
                document.body.appendChild(modal);
                document.getElementById('modalOverlay').style.display = 'block';
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error asking AI:', error);
                alert('Error getting AI response. Please try again.');
            }
        }

        function toggleResearchAssistant() {
            const assistant = document.getElementById('researchAssistant');
            const isVisible = assistant.style.display !== 'none';
            assistant.style.display = isVisible ? 'none' : 'block';
        }

        async function handleResearchQuery(event) {
            if (event.key === 'Enter') {
                const query = event.target.value;
                await performResearch(query);
            }
        }

        async function runExample(query) {
            document.querySelector('.research-query').value = query;
            await performResearch(query);
        }

        async function performResearch(query) {
            const resultsDiv = document.getElementById('researchResults');
            resultsDiv.innerHTML = '<p>Researching...</p>';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Research Assistant: ${query}\nProvide a detailed response with examples and best practices. Focus on practical implementation details and real-world use cases.`,
                        model: 'gpt-4'
                    })
                });

                const result = await response.json();
                
                resultsDiv.innerHTML = `
                    <div class="research-response">
                        <h4>Research Results</h4>
                        <div class="markdown-content">${result.content}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error performing research:', error);
                resultsDiv.innerHTML = '<p>Error performing research. Please try again.</p>';
            }
        }

        // Tab switching with error handling
        async function showTab(tabId) {
            try {
                // Validate tab exists
                const tab = document.getElementById(tabId + '-content');
                if (!tab) {
                    throw new Error(`Tab '${tabId}' not found`);
                }

                // Try to load tab content
                if (tabId === 'prompts') {
                    await loadPromptIndex();
                } else if (tabId === 'workshop') {
                    await loadWorkshop();
                }

                // If successful, switch tabs
                document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
                tab.style.display = 'block';

                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');

                // Save active tab to localStorage
                localStorage.setItem('activeTab', tabId);
            } catch (error) {
                console.error('Tab error:', error);
                
                // Show error visualization
                const button = event.target;
                button.classList.add('has-error');
                
                // Create error indicator if doesn't exist
                let indicator = button.querySelector('.error-indicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.className = 'error-indicator';
                    button.appendChild(indicator);
                }

                // Create or update tooltip
                let tooltip = button.querySelector('.error-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'error-tooltip';
                    button.appendChild(tooltip);
                }

                // Generate AI fixes
                const fixes = await generateFixes(error, tabId);
                
                tooltip.innerHTML = `
                    <strong>Error:</strong> ${error.message}<br>
                    <div class="error-location">
                        Tab: ${tabId}<br>
                        Type: ${error.name}
                    </div>
                    ${fixes.map((fix, index) => `
                        <div class="fix-option ${fix.type}" onclick="applyTabFix('${tabId}', ${index})">
                            <div class="fix-description">${fix.description}</div>
                            <div class="fix-explanation">${fix.explanation}</div>
                            <div class="fix-confidence">Confidence: ${Math.round(fix.confidence * 100)}%</div>
                            <button class="apply-fix-btn">Apply Fix</button>
                        </div>
                    `).join('')}
                `;
            }
        }

        async function generateFixes(error, tabId) {
            try {
                // Call OpenAI to generate fixes
                const response = await fetch('/api/generate-fixes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ error: error.message, context: tabId })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate fixes');
                }

                return await response.json();
            } catch (err) {
                console.error('Error generating fixes:', err);
                return [{
                    description: "Reload the page",
                    explanation: "This will reset the application state",
                    type: "safe",
                    confidence: 0.8
                }, {
                    description: "Clear application cache",
                    explanation: "This will clear any corrupted state",
                    type: "enhanced",
                    confidence: 0.6
                }];
            }
        }

        async function applyTabFix(tabId, fixIndex) {
            try {
                const button = document.querySelector(`[data-tab="${tabId}"]`);
                
                // Remove error state
                button.classList.remove('has-error');
                
                // Remove error indicators
                const indicator = button.querySelector('.error-indicator');
                const tooltip = button.querySelector('.error-tooltip');
                if (indicator) indicator.remove();
                if (tooltip) tooltip.remove();

                // Try showing the tab again
                await showTab(tabId);
            } catch (error) {
                console.error('Error applying fix:', error);
            }
        }

        // Error handling setup
        window.addEventListener('system-error', (event) => {
            const { nearestElement, message, fixes } = event.detail;
            const element = document.getElementById(nearestElement);
            
            if (element) {
                // Add error highlighting
                element.classList.add('error-highlight');
                
                // Create tooltip
                const tooltip = document.createElement('div');
                tooltip.className = 'error-tooltip';
                
                // Add error message
                const errorMessage = document.createElement('div');
                errorMessage.textContent = message;
                errorMessage.style.marginBottom = '8px';
                tooltip.appendChild(errorMessage);
                
                // Add fix buttons
                fixes.forEach((fix, index) => {
                    const button = document.createElement('button');
                    button.className = `fix-button ${fix.type}`;
                    button.textContent = fix.description;
                    
                    const confidence = document.createElement('div');
                    confidence.className = 'confidence';
                    confidence.textContent = `Confidence: ${Math.round(fix.confidence * 100)}%`;
                    
                    const explanation = document.createElement('div');
                    explanation.style.fontSize = '12px';
                    explanation.style.marginTop = '4px';
                    explanation.textContent = fix.explanation;
                    
                    button.onclick = () => {
                        window.errorTracker.applyFix(nearestElement, index);
                    };
                    
                    tooltip.appendChild(button);
                    tooltip.appendChild(confidence);
                    tooltip.appendChild(explanation);
                });
                
                element.appendChild(tooltip);
            }
        });

        window.addEventListener('fix-applied', (event) => {
            const { nearestElement } = event.detail;
            const element = document.getElementById(nearestElement);
            
            if (element) {
                element.classList.remove('error-highlight');
                const tooltip = element.querySelector('.error-tooltip');
                if (tooltip) {
                    element.removeChild(tooltip);
                }
            }
        });

        window.addEventListener('error-cleared', (event) => {
            const { nearestElement } = event.detail;
            const element = document.getElementById(nearestElement);
            
            if (element) {
                element.classList.remove('error-highlight');
                const tooltip = element.querySelector('.error-tooltip');
                if (tooltip) {
                    element.removeChild(tooltip);
                }
            }
        });

        // Tab functionality
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            function showTab(tabId) {
                try {
                    // Hide all content sections
                    contents.forEach(content => {
                        content.style.display = 'none';
                    });

                    // Remove active class from all tabs
                    tabs.forEach(tab => {
                        tab.classList.remove('active');
                    });

                    // Show selected content and activate tab
                    const selectedContent = document.getElementById(tabId + '-content');
                    const selectedTab = document.querySelector(`[data-tab="${tabId}"]`);

                    if (!selectedContent || !selectedTab) {
                        throw new Error(`Tab ${tabId} or its content not found`);
                    }

                    selectedContent.style.display = 'block';
                    selectedTab.classList.add('active');

                    // Save active tab to localStorage
                    localStorage.setItem('activeTab', tabId);
                } catch (error) {
                    console.error('Error showing tab:', error);
                    window.errorTracker.trackError(error);
                }
            }

            // Add click handlers to tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    showTab(tabId);
                });
            });

            // Show last active tab or default to chat
            const lastActiveTab = localStorage.getItem('activeTab') || 'chat';
            showTab(lastActiveTab);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            initializeTabs();
        });

        // Chat functionality
        let messages = [];

        function addMessage(content, isUser = false) {
            const message = {
                content,
                isUser,
                timestamp: new Date()
            };
            
            messages.push(message);
            displayMessages();
        }

        function displayMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = messages.map(msg => `
                <div class="message ${msg.isUser ? 'user-message' : 'bot-message'}">
                    ${msg.content}
                </div>
            `).join('');
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handleSendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, true);
                input.value = '';
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message })
                    });
                    
                    const data = await response.json();
                    addMessage(data.response);
                } catch (error) {
                    console.error('Chat error:', error);
                    window.errorTracker.trackError(error);
                }
            }
        }

        // Workshop functionality
        async function loadTool(toolType) {
            const toolContent = document.getElementById('toolContent');
            
            try {
                const response = await fetch(`/api/tools/${toolType}`);
                const data = await response.json();
                
                toolContent.innerHTML = `
                    <h3>${data.name}</h3>
                    <p>${data.description}</p>
                    <div class="tool-interface">
                        ${data.interface}
                    </div>
                `;
            } catch (error) {
                console.error('Tool loading error:', error);
                window.errorTracker.trackError(error);
            }
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const sendButton = document.getElementById('sendMessage');
            const chatInput = document.getElementById('chatInput');
            
            if (sendButton && chatInput) {
                sendButton.addEventListener('click', handleSendMessage);
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
            }
            
            // Add welcome message
            addMessage('Hello! How can I help you today?', false);
        });

        // Workshop functionality
        async function loadWorkshop() {
            const tools = await fetch('/api/tools').then(r => r.json());
            const toolsGrid = document.getElementById('toolsGrid');
            
            tools.forEach(tool => {
                const toolCard = document.createElement('div');
                toolCard.className = 'tool-card';
                toolCard.innerHTML = `
                    <h4>${tool.name}</h4>
                    <p>${tool.description}</p>
                    <button class="button" onclick="addToolToWorkflow('${tool.id}')">Add to Workflow</button>
                `;
                toolsGrid.appendChild(toolCard);
            });

            loadSavedWorkflows();
        }

        async function loadSavedWorkflows() {
            const workflows = await fetch('/api/workflows').then(r => r.json());
            const workflowList = document.getElementById('workflowList');
            
            workflowList.innerHTML = workflows.map(workflow => `
                <div class="workflow-item">
                    <h4>${workflow.name}</h4>
                    <p>${workflow.description}</p>
                    <div class="workflow-actions">
                        <button class="button" onclick="executeWorkflow('${workflow.id}')">Run</button>
                        <button class="button" onclick="editWorkflow('${workflow.id}')">Edit</button>
                        <button class="button danger" onclick="deleteWorkflow('${workflow.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addToolToWorkflow(toolId) {
            const workflowSteps = document.getElementById('workflowSteps');
            const stepDiv = document.createElement('div');
            stepDiv.className = 'workflow-step';
            stepDiv.innerHTML = `
                <select class="tool-select">
                    <option value="${toolId}">${toolId}</option>
                </select>
                <input type="text" placeholder="Parameters" class="step-params">
                <button class="button danger" onclick="this.parentElement.remove()">Remove</button>
            `;
            workflowSteps.appendChild(stepDiv);
        }

        async function saveWorkflow() {
            const steps = Array.from(document.querySelectorAll('.workflow-step')).map(step => ({
                tool: step.querySelector('.tool-select').value,
                params: step.querySelector('.step-params').value
            }));

            const name = prompt('Enter workflow name:');
            if (!name) return;

            const workflow = {
                name,
                steps
            };

            await fetch('/api/workflows', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(workflow)
            });

            loadSavedWorkflows();
        }
    </script>
</body>
</html>
